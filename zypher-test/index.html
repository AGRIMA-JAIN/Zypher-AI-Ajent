<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fitness Plan Sheet · Zypher</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #0b0b0d;
      color: #f5f5f5;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      height: 100vh;
    }
    .left, .right {
      padding: 24px 32px;
      overflow: auto;
    }
    .left {
      background: #0f1014;
    }
    .right {
      background: #050509;
      border-left: 1px solid #262633;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 28px;
      letter-spacing: 0.02em;
    }
    .subtitle {
      margin-bottom: 20px;
      color: #b3b3c2;
      font-size: 14px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #a3a3b3;
    }
    input, textarea, select, button {
      font-family: inherit;
      font-size: 14px;
    }
    .field {
      margin-bottom: 14px;
      max-width: 420px;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #333348;
      background: #14151e;
      color: #f5f5ff;
    }
    input[type="number"] {
      width: 90px;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, monospace;
      font-size: 12px;
      white-space: pre;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff6b9c, #ff8f5a);
      color: white;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
    }
    button.secondary {
      background: transparent;
      border: 1px solid #44445a;
      color: #d0d0e0;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    table {
      margin-top: 18px;
      border-collapse: collapse;
      width: 100%;
      background: #111118;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #2c2c3a;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #181824;
      font-weight: 600;
      text-align: left;
    }
    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin: 18px 0 4px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #141823;
      color: #b5b5ff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .log {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, monospace;
      font-size: 11px;
      background: #050509;
      border-radius: 8px;
      border: 1px solid #242437;
      padding: 10px;
      height: calc(100vh - 120px);
      overflow: auto;
    }
    .log-line {
      margin-bottom: 4px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- LEFT: Controls + Sheet -->
    <div class="left">
      <h1>Fitness Plan Sheet</h1>
      <div class="subtitle">
        Describe your goal and how many days you can train.  
        Zypher will build a one-week workout sheet you can edit with natural language.
      </div>

      <form id="generateForm">
        <div class="field">
          <label for="goal">Fitness Goal</label>
          <input
            id="goal"
            type="text"
            placeholder="e.g. Beginner, low-impact, home workout"
            required
          />
        </div>

        <div class="field">
          <label for="days">Days per Week</label>
          <input id="days" type="number" min="1" max="7" value="5" />
        </div>

        <button id="generateBtn" type="submit">Generate Plan</button>
        <button
          id="resetBtn"
          type="button"
          class="secondary"
        >Reset</button>
      </form>

      <div class="panel-title">
        Current Sheet
        <span class="tag">CSV + Table</span>
      </div>

      <!-- Raw CSV (what we send back to Zypher for edits) -->
      <div class="field">
        <label for="csvText">Raw CSV (editable)</label>
        <textarea id="csvText" spellcheck="false" placeholder="Generated CSV will appear here…"></textarea>
      </div>

      <!-- Edit controls -->
      <div class="panel-title">Edit with Natural Language</div>
      <form id="editForm">
        <div class="field">
          <label for="editInstructions">Edit instructions</label>
          <textarea
            id="editInstructions"
            spellcheck="false"
            placeholder='Examples:
- "Delete Sunday."
- "Change Wednesday to active recovery with light yoga."
- "Add a new leg day focused on glutes and hamstrings."'
          ></textarea>
        </div>
        <button id="editBtn" type="submit">Apply Edit</button>
      </form>

      <!-- Pretty table -->
      <div id="tableContainer"></div>
    </div>

    <!-- RIGHT: Log -->
    <div class="right">
      <h2>Sheet by Zypher</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const generateForm = document.getElementById("generateForm");
    const editForm = document.getElementById("editForm");
    const generateBtn = document.getElementById("generateBtn");
    const editBtn = document.getElementById("editBtn");
    const resetBtn = document.getElementById("resetBtn");
    const goalInput = document.getElementById("goal");
    const daysInput = document.getElementById("days");
    const csvText = document.getElementById("csvText");
    const editInstructions = document.getElementById("editInstructions");
    const tableContainer = document.getElementById("tableContainer");
    const logBox = document.getElementById("log");

    function log(lines) {
      const arr = Array.isArray(lines) ? lines : [lines];
      for (const line of arr) {
        const div = document.createElement("div");
        div.className = "log-line";
        const now = new Date().toLocaleTimeString();
        div.textContent = `[${now}] ${line}`;
        logBox.appendChild(div);
      }
      logBox.scrollTop = logBox.scrollHeight;
    }

    function parseCsv(csv) {
      // super-simple CSV parser (good enough for our generated data)
      const lines = csv
        .trim()
        .replace(/^```csv/i, "")
        .replace(/```$/i, "")
        .split(/\r?\n/)
        .filter((l) => l.trim().length);

      if (!lines.length) return { headers: [], rows: [] };

      const splitLine = (line) => {
        const cells = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (ch === "," && !inQuotes) {
            cells.push(current.trim());
            current = "";
          } else {
            current += ch;
          }
        }
        cells.push(current.trim());
        return cells;
      };

      const headers = splitLine(lines[0]);
      const rows = lines.slice(1).map(splitLine);
      return { headers, rows };
    }

    function renderTableFromCsv(csv) {
      const { headers, rows } = parseCsv(csv);
      if (!headers.length) {
        tableContainer.innerHTML = "";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      headers.forEach((h) => {
        const th = document.createElement("th");
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach((cols) => {
        const tr = document.createElement("tr");
        headers.forEach((_, idx) => {
          const td = document.createElement("td");
          td.textContent = cols[idx] ?? "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      tableContainer.innerHTML = "";
      tableContainer.appendChild(table);
    }

    async function postJson(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    generateForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const goal = goalInput.value.trim();
      const days = Number(daysInput.value || 5);

      if (!goal) return;

      generateBtn.disabled = true;
      editBtn.disabled = true;
      log(`User: Generate plan (goal="${goal}", days=${days})`);

      try {
        const data = await postJson("/api/plan", { goal, days });
        csvText.value = data.csv;
        renderTableFromCsv(data.csv);
        if (data.log) log(data.log);
      } catch (err) {
        console.error(err);
        log("❌ Error generating plan");
      } finally {
        generateBtn.disabled = false;
        editBtn.disabled = false;
      }
    });

    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const csv = csvText.value.trim();
      const instructions = editInstructions.value.trim();

      if (!csv) {
        alert("No plan to edit yet.");
        return;
      }
      if (!instructions) {
        alert("Please enter edit instructions.");
        return;
      }

      editBtn.disabled = true;
      generateBtn.disabled = true;
      log(`User: Edit plan -> "${instructions}"`);

      try {
        const data = await postJson("/api/plan/edit", { csv, instructions });
        csvText.value = data.csv;
        renderTableFromCsv(data.csv);
        if (data.log) log(data.log);
        editInstructions.value = "";
      } catch (err) {
        console.error(err);
        log("❌ Error editing plan");
      } finally {
        editBtn.disabled = false;
        generateBtn.disabled = false;
      }
    });

    resetBtn.addEventListener("click", () => {
      csvText.value = "";
      tableContainer.innerHTML = "";
      editInstructions.value = "";
      log("Sheet reset locally (no API call).");
    });

    // Optional default example goal so you can just hit "Generate Plan"
    goalInput.value =
      "4-day low-impact routine to lose fat and improve stamina, using only dumbbells and a yoga mat at home. Focus on posture and back health.";
  </script>
</body>
</html>
